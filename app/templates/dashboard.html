<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UI Toolkit - Dashboard</title>
    <link rel="icon" type="image/jpeg" href="/static/images/favicon16x16.jpg">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <script>
        // Gespeichertes Theme sofort anwenden um Flackern zu vermeiden
        (function() {
            const savedTheme = localStorage.getItem('unifi-toolkit-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-left"><img src="/static/images/vonbusch-logo.svg" class="logo-light" style="max-height:40px;width:auto;"><img src="/static/images/vonbusch-logo-white.svg" class="logo-dark" style="max-height:40px;width:auto;display:none;">
                    
                    
                </div>
                <div class="header-center">
                    <h1>UI Toolkit</h1>
                </div>
                <div class="header-right">
                    <div class="header-actions">
                        <div class="theme-toggle">
                            <span class="theme-toggle-label" id="theme-label">Hell</span>
                            <button class="theme-toggle-btn" id="theme-toggle" title="Hell/Dunkel umschalten">
                                <span id="theme-icon">üåô</span>
                            </button>
                        </div>
                        <button class="settings-btn" id="settings-btn" title="UniFi Einstellungen">
                            <span class="settings-icon">‚öôÔ∏è</span>
                        </button>
                        {% if auth_enabled %}
                        <a href="/logout" class="logout-btn" title="Abmelden">
                            <span class="logout-icon">üö™</span>
                            <span class="logout-label">Abmelden</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </header>

        <!-- Systemstatus Widget -->
        <section class="system-status" id="system-status">
            <div class="status-header" id="status-header">
                <div class="status-summary">
                    <div class="status-item" id="gateway-status">
                        <span class="status-icon">üîå</span>
                        <span class="status-label">Gateway</span>
                        <span class="status-value" id="gateway-model">--</span>
                    </div>
                    <div class="status-item" id="cpu-status">
                        <span class="status-icon">‚ö°</span>
                        <span class="status-label">CPU</span>
                        <span class="status-value" id="cpu-value">--%</span>
                    </div>
                    <div class="status-item" id="ram-status">
                        <span class="status-icon">üíæ</span>
                        <span class="status-label">RAM</span>
                        <span class="status-value" id="ram-value">--%</span>
                    </div>
                    <div class="status-item" id="uptime-status">
                        <span class="status-icon">‚è±Ô∏è</span>
                        <span class="status-label">Laufzeit</span>
                        <span class="status-value" id="uptime-value">--</span>
                    </div>
                    <div class="status-item" id="wan-status">
                        <span class="status-icon" id="wan-icon">üåê</span>
                        <span class="status-label">WAN</span>
                        <span class="status-value" id="wan-value">--</span>
                    </div>
                    <div class="status-item" id="clients-status">
                        <span class="status-icon">üì±</span>
                        <span class="status-label">Clients</span>
                        <span class="status-value" id="clients-value">--</span>
                    </div>
                </div>
                <button class="status-expand-btn" id="status-expand-btn" title="Details anzeigen">
                    <span id="expand-icon">‚ñº</span>
                </button>
            </div>
            <div class="status-details" id="status-details">
                <div class="status-details-grid">
                    <!-- Ger√§teanzahl -->
                    <div class="detail-card">
                        <h4>Netzwerkger√§te</h4>
                        <div class="detail-list">
                            <div class="detail-row">
                                <span>Access Points</span>
                                <span id="ap-count">--</span>
                            </div>
                            <div class="detail-row">
                                <span>Switches</span>
                                <span id="switch-count">--</span>
                            </div>
                            <div class="detail-row">
                                <span>Verbundene Clients</span>
                                <span id="client-count-detail">--</span>
                            </div>
                        </div>
                    </div>
                    <!-- Gateway Details -->
                    <div class="detail-card">
                        <h4>Gateway Info</h4>
                        <div class="detail-list">
                            <div class="detail-row">
                                <span>Modell</span>
                                <span id="gateway-model-detail">--</span>
                            </div>
                            <div class="detail-row">
                                <span>Firmware</span>
                                <span id="gateway-version">--</span>
                            </div>
                            <div class="detail-row">
                                <span>WAN IP</span>
                                <span id="wan-ip" class="wan-ip-hidden" title="Klicken zum Anzeigen" data-revealed="false">--</span>
                            </div>
                            <div class="detail-row" id="wan2-row" style="display: none;">
                                <span>WAN2 IP</span>
                                <span id="wan2-ip" class="wan-ip-hidden" title="Klicken zum Anzeigen" data-revealed="false">--</span>
                            </div>
                            <div class="detail-row">
                                <span>WAN Verf√ºgbarkeit</span>
                                <span id="wan-availability">--</span>
                            </div>
                            <div class="detail-row" id="wan2-availability-row" style="display: none;">
                                <span>WAN2 Verf√ºgbarkeit</span>
                                <span id="wan2-availability">--</span>
                            </div>
                        </div>
                    </div>
                    <!-- Internetstatistik -->
                    <div class="detail-card">
                        <h4>Internetstatistik</h4>
                        <div class="detail-list">
                            <div class="detail-row">
                                <span>Latenz</span>
                                <span id="wan-latency">--</span>
                            </div>
                            <div class="detail-row">
                                <span>Download</span>
                                <span id="current-download">--</span>
                            </div>
                            <div class="detail-row">
                                <span>Upload</span>
                                <span id="current-upload">--</span>
                            </div>
                        </div>
                    </div>
                    <!-- Netzwerkstatus -->
                    <div class="detail-card">
                        <h4>Netzwerkstatus</h4>
                        <div class="detail-list">
                            <div class="detail-row">
                                <span class="health-label-group">
                                    <span>WAN</span>
                                    <span class="health-reason" id="wan-reason"></span>
                                </span>
                                <span class="health-badge" id="wan-health">--</span>
                            </div>
                            <div class="detail-row" id="wan2-health-row" style="display: none;">
                                <span class="health-label-group">
                                    <span>WAN2</span>
                                    <span class="health-reason" id="wan2-reason"></span>
                                </span>
                                <span class="health-badge" id="wan2-health">--</span>
                            </div>
                            <div class="detail-row">
                                <span class="health-label-group">
                                    <span>LAN</span>
                                    <span class="health-reason" id="lan-reason"></span>
                                </span>
                                <span class="health-badge" id="lan-health">--</span>
                            </div>
                            <div class="detail-row">
                                <span class="health-label-group">
                                    <span>WLAN</span>
                                    <span class="health-reason" id="wlan-reason"></span>
                                </span>
                                <span class="health-badge" id="wlan-health">--</span>
                            </div>
                            <div class="detail-row" id="vpn-health-row" style="display: none;">
                                <span class="health-label-group">
                                    <span>VPN</span>
                                    <span class="health-reason" id="vpn-reason"></span>
                                </span>
                                <span class="health-badge" id="vpn-health">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="status-loading" id="status-loading">
                <span>Systemstatus wird geladen...</span>
            </div>
            <div class="status-error" id="status-error">
                <span id="error-message">Verbindung nicht m√∂glich</span>
                <a href="#" class="configure-link" id="configure-link">UniFi Verbindung konfigurieren</a>
            </div>
        </section>

        <!-- UniFi Konfigurationsmodal -->
        <div id="config-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>UniFi Controller Konfiguration</h2>
                    <button class="close-btn" id="close-modal-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="config-form">
                        <div class="form-group">
                            <label for="controller_url">Controller URL *</label>
                            <input type="text"
                                   id="controller_url"
                                   name="controller_url"
                                   placeholder="https://192.168.200.1"
                                   required>
                            <small>UCG/UDM/UDR: https://192.168.x.x &nbsp;|&nbsp; Legacy Controller: https://192.168.x.x:8443</small>
                        </div>

                        <div class="auth-info-box">
                            <strong>Authentifizierung:</strong>
                            <p>
                                üîê <strong>API Key (empfohlen f√ºr UniFi OS):</strong> UCG, UDM, UDR, Cloud Key, UniFi OS Server<br>
                                <small style="margin-left: 1.5em; color: var(--text-muted);">Zuverl√§ssiger ‚Äì keine Sitzungsabbr√ºche, umgeht 2FA</small><br>
                                üîë <strong>Benutzername/Passwort:</strong> Alle Controller (erkennt UniFi OS vs. Legacy automatisch)<br>
                                <small style="margin-left: 1.5em; color: var(--text-muted);">Erforderlich f√ºr selbst gehosteten Legacy Network Controller</small>
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="api_key">API Key</label>
                            <input type="password"
                                   id="api_key"
                                   name="api_key"
                                   placeholder="API Key aus UniFi Einstellungen > Integrationen eingeben">
                            <small>In UniFi OS: Einstellungen ‚Üí Integrationen ‚Üí API Keys. Leer lassen wenn Benutzername/Passwort verwendet wird.</small>
                        </div>

                        <div class="form-group">
                            <label for="username">Benutzername</label>
                            <input type="text"
                                   id="username"
                                   name="username"
                                   placeholder="admin"
                                   value="admin">
                            <small>Leer lassen wenn API Key verwendet wird</small>
                        </div>

                        <div class="form-group">
                            <label for="password">Passwort</label>
                            <input type="password"
                                   id="password"
                                   name="password"
                                   placeholder="Ihr Passwort">
                            <small>Leer lassen wenn API Key verwendet wird</small>
                        </div>

                        <div class="form-group">
                            <label for="site_id">Site ID</label>
                            <input type="text"
                                   id="site_id"
                                   name="site_id"
                                   value="default">
                            <small>‚Äûdefault" f√ºr Einzelstandort-Setups. F√ºr mehrere Standorte die ID aus der URL verwenden (nicht den Anzeigenamen). Beispiel: bei URL <code>/manage/site/abc123/...</code> ‚Üí <code>abc123</code></small>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox"
                                       id="verify_ssl"
                                       name="verify_ssl">
                                SSL-Zertifikate √ºberpr√ºfen
                            </label>
                            <small>Deaktivieren bei selbstsignierten Zertifikaten (bei den meisten UniFi-Installationen)</small>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Konfiguration speichern</button>
                            <button type="button" id="test-connection-btn" class="btn btn-secondary">
                                Verbindung testen
                            </button>
                            <button type="button" id="cancel-config-btn" class="btn btn-secondary">
                                Abbrechen
                            </button>
                        </div>

                        <div id="config-message" class="message" style="display: none;"></div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Hauptinhalt -->
        <main class="main-content">
            <!-- Tool-Raster -->
            <div class="tools-grid">
                <!-- Wi-Fi Stalker Tool -->
                <div class="tool-card">
                    <div class="tool-icon">üì°</div>
                    <h2>Wi-Fi Stalker</h2>
                    <p class="tool-description">
                        Verfolgen Sie spezifische WLAN-Clients in Ihrer UniFi-Infrastruktur.
                        Verbindungsstatus √ºberwachen, Roaming zwischen Access Points erkennen und
                        historische Protokolle der Ger√§tebewegungen f√ºhren.
                    </p>
                    <div class="tool-features">
                        <span class="feature-badge">Ger√§teverfolgung</span>
                        <span class="feature-badge">Roaming-Erkennung</span>
                        <span class="feature-badge">Verlaufsprotokoll</span>
                    </div>
                    <div class="tool-bottom">
                        <div class="tool-actions">
                            <a href="/stalker/" class="btn btn-primary">Wi-Fi Stalker √∂ffnen</a>
                        </div>
                        <div class="tool-version">v{{ stalker_version }}</div>
                    </div>
                </div>

                <!-- Threat Watch Tool -->
                <div class="tool-card" id="threat-watch-card">
                    <div class="tool-icon">üõ°Ô∏è</div>
                    <h2>Threat Watch</h2>
                    <p class="tool-description">
                        IDS/IPS-Ereignisse in Echtzeit √ºberwachen, blockierte Bedrohungen und
                        Top-Angreifer anzeigen sowie Sicherheitstrends in Ihrem UniFi-Netzwerk analysieren.
                    </p>
                    <div class="tool-features">
                        <span class="feature-badge">IDS/IPS Ereignisse</span>
                        <span class="feature-badge">Top-Angreifer</span>
                        <span class="feature-badge">Geo-Lookup</span>
                    </div>
                    <div class="tool-status" id="threat-watch-status" style="display: none;"></div>
                    <div class="tool-bottom">
                        <div class="tool-actions">
                            <a href="/threats/" class="btn btn-primary" id="threat-watch-btn">Threat Watch √∂ffnen</a>
                        </div>
                        <div class="tool-version">v{{ threat_watch_version }}</div>
                    </div>
                </div>

                <!-- Network Pulse Tool -->
                <div class="tool-card">
                    <div class="tool-icon">üíì</div>
                    <h2>Network Pulse</h2>
                    <p class="tool-description">
                        Echtzeit-Netzwerk√ºberwachungs-Dashboard f√ºr Daueranzeigen.
                        Bandbreite, AP-Status, Top-Clients und Netzwerkzustand auf einen Blick.
                    </p>
                    <div class="tool-features">
                        <span class="feature-badge">Live-Statistiken</span>
                        <span class="feature-badge">Client-Nutzung</span>
                        <span class="feature-badge">Vollbildmodus</span>
                    </div>
                    <div class="tool-bottom">
                        <div class="tool-actions">
                            <a href="/pulse/" class="btn btn-primary">Network Pulse √∂ffnen</a>
                        </div>
                        <div class="tool-version">v{{ pulse_version }}</div>
                    </div>
                </div>

                <div class="tool-card">
                    <div class="tool-icon tool-icon-image">
                        <img src="/static/images/ubiquiti_logo.png" alt="Ubiquiti">
                    </div>
                    <h2>UI Design Center</h2>
                    <p class="tool-description">
                        Das perfekte UniFi-Netzwerk zusammenstellen. Produkte ausw√§hlen, teilbare
                        Konfigurationen erstellen und auf Ihre Bed√ºrfnisse zugeschnittene Empfehlungen erhalten. V√∂llig kostenlos.
                    </p>
                    <div class="tool-features">
                        <span class="feature-badge">Produktauswahl</span>
                        <span class="feature-badge">Build teilen</span>
                        <span class="feature-badge">Community</span>
                    </div>
                    <div class="tool-bottom">
                        <div class="tool-actions">
                            <a href="https://design.ui.com" target="_blank" class="btn btn-primary">UI Design Center √∂ffnen</a>
                        </div>
                        <div class="tool-version">&nbsp;</div>
                    </div>
                </div>
            </div>

            <!-- Info-Bereich -->
            <div class="info-section">
                <div class="info-card">
                    <h3>√úber UI Toolkit</h3>
                    <p>
                        UI Toolkit ist eine umfassende Sammlung von Tools zur Verbesserung Ihrer
                        UniFi-Netzwerkverwaltung. Jedes Tool ist speziell entwickelt, um bestimmte
                        Netzwerkprobleme zu l√∂sen und tiefe Einblicke in Ihre Infrastruktur zu liefern.
                    </p>
                    <p>
                        Alle Tools teilen eine gemeinsame UniFi Controller-Konfiguration, was die
                        Verwaltung mehrerer Funktionen aus einer einzigen Installation einfach macht.
                    </p>
                </div>

                <div class="info-card">
                    <h3>Erste Schritte</h3>
                    <ol>
                        <li>Ein Tool aus dem Raster oben ausw√§hlen</li>
                        <li>UniFi Controller-Verbindung konfigurieren</li>
                        <li>Die Funktionen des Tools nutzen</li>
                        
                    </ol>
                    <p>
                        Jedes Tool hat seine eigene Konfiguration und Daten, nutzt jedoch gemeinsame
                        Infrastruktur f√ºr Authentifizierung und UniFi API-Zugriff.
                    </p>
                </div>

                <div class="info-card">
                    <h3>Systemanforderungen</h3>
                    <ul>
                        <li>UniFi Network Controller (Cloud Key, UDM, UCG oder Standalone)</li>
                        <li>Python 3.9 - 3.12</li>
                        <li>Zugriff auf die UniFi Controller API</li>
                        <li>Moderner Webbrowser mit aktiviertem JavaScript</li>
                    </ul>
                </div>
            </div>

            <!-- Promo-Banner -->
            <div class="promo-banner">
                <a href="https://Rogue.Support" target="_blank" rel="noopener noreferrer" title="Rogue Support - Netzwerkberatung f√ºr Heimanwender">
                    <img src="/static/images/RS-banner-new3-1200x400.png" alt="Rogue Support - Ihr Uber f√ºr Computer-Networking">
                </a>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>
                <a href="https://github.com/axelweichert/unifi-toolkit" target="_blank">UI Toolkit</a>
                v{{ app_version }} | von
                <a href="https://www.vonbusch.digital" target="_blank">vonBusch GmbH</a>
            </p>
            <p class="footer-links">
                <a href="/health">Systempr√ºfung</a> |
                <a href="#" id="report-issue-link" target="_blank">Problem melden</a> |
                <a href="https://github.com/axelweichert/unifi-toolkit#readme" target="_blank">Dokumentation</a> |
                
            </p>
            <p class="footer-disclaimer">
                Dieses Projekt ist nicht mit Ubiquiti Inc. verbunden, wird nicht von Ubiquiti Inc. unterst√ºtzt oder gesponsert.
                UniFi ist eine Marke von Ubiquiti Inc.
            </p>
        </footer>
    </div>

    <script>
        // Theme-Umschaltfunktion
        (function() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const themeLabel = document.getElementById('theme-label');

            function updateThemeUI(theme) {
                if (theme === "dark") { document.querySelector(".logo-dark").style.display="block"; document.querySelector(".logo-light").style.display="none"; } else { document.querySelector(".logo-dark").style.display="none"; document.querySelector(".logo-light").style.display="block"; }
                if (theme === 'dark') {
                    themeIcon.textContent = '‚òÄÔ∏è';
                    themeLabel.textContent = 'Dunkel';
                } else {
                    themeIcon.textContent = 'üåô';
                    themeLabel.textContent = 'Hell';
                }
            }

            // UI basierend auf aktuellem Theme initialisieren
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            updateThemeUI(currentTheme);

            // Theme bei Klick umschalten
            themeToggle.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('unifi-toolkit-theme', newTheme);
                updateThemeUI(newTheme);
            });
        })();

        // Systemstatus Widget
        (function() {
            const statusHeader = document.getElementById('status-header');
            const statusDetails = document.getElementById('status-details');
            const statusExpandBtn = document.getElementById('status-expand-btn');
            const statusLoading = document.getElementById('status-loading');
            const statusError = document.getElementById('status-error');
            const errorMessage = document.getElementById('error-message');

            let hasLoadedOnce = false;

            // Laufzeit in lesbare Form formatieren
            function formatUptime(seconds) {
                if (!seconds) return '--';
                const days = Math.floor(seconds / 86400);
                const hours = Math.floor((seconds % 86400) / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);

                if (days > 0) {
                    return `${days}T ${hours}Std`;
                } else if (hours > 0) {
                    return `${hours}Std ${minutes}Min`;
                } else {
                    return `${minutes}Min`;
                }
            }

            // Durchsatz formatieren (Bytes/Sek zu Bits/Sek)
            function formatThroughput(bytesPerSec) {
                if (!bytesPerSec || bytesPerSec === 0) return '--';

                const bitsPerSec = bytesPerSec * 8;
                const kbps = bitsPerSec / 1000;
                const mbps = kbps / 1000;

                if (mbps >= 1) {
                    return `${mbps.toFixed(1)} Mbps`;
                } else if (kbps >= 1) {
                    return `${kbps.toFixed(1)} Kbps`;
                } else {
                    return `${Math.round(bitsPerSec)} bps`;
                }
            }

            // Status-Badge und Grund setzen
            function setHealthBadge(elementId, status, reason) {
                const element = document.getElementById(elementId);
                if (!element) return;

                element.textContent = status || '--';
                element.className = 'health-badge';

                if (status === 'ok') {
                    element.classList.add('ok');
                    element.textContent = 'OK';
                } else if (status === 'warning') {
                    element.classList.add('warning');
                    element.textContent = 'WARN';
                } else if (status === 'error' || status === 'unknown') {
                    element.classList.add('error');
                    element.textContent = status === 'unknown' ? 'N/V' : 'ERR';
                }

                const reasonId = elementId.replace('-health', '-reason');
                const reasonElement = document.getElementById(reasonId);
                if (reasonElement) {
                    reasonElement.textContent = reason || '';
                }
            }

            // Akkordeon umschalten
            statusExpandBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                statusDetails.classList.toggle('expanded');
                statusExpandBtn.classList.toggle('expanded');
            });

            statusHeader.addEventListener('click', function() {
                statusDetails.classList.toggle('expanded');
                statusExpandBtn.classList.toggle('expanded');
            });

            // WAN IP ein-/ausblenden
            function setupWanIpToggle(elementId) {
                const el = document.getElementById(elementId);
                if (!el) return;

                el.addEventListener('click', function() {
                    const ip = this.dataset.ip;
                    if (!ip || ip === '--') return;

                    const isRevealed = this.dataset.revealed === 'true';
                    if (isRevealed) {
                        this.textContent = '(zum Anzeigen klicken)';
                        this.dataset.revealed = 'false';
                        this.title = 'Klicken zum Anzeigen';
                    } else {
                        this.textContent = ip;
                        this.dataset.revealed = 'true';
                        this.title = 'Klicken zum Verbergen';
                    }
                });
            }

            setupWanIpToggle('wan-ip');
            setupWanIpToggle('wan2-ip');

            // Systemstatus laden
            async function loadSystemStatus() {
                if (!hasLoadedOnce) {
                    statusLoading.classList.add('visible');
                    statusHeader.classList.add('hidden');
                }
                statusError.classList.remove('visible');

                try {
                    const response = await fetch('/api/system-status');
                    const data = await response.json();

                    statusLoading.classList.remove('visible');

                    if (!data.configured) {
                        statusHeader.classList.add('hidden');
                        statusError.classList.add('visible');
                        errorMessage.textContent = 'UniFi Controller nicht konfiguriert';
                        hasLoadedOnce = false;
                        return;
                    }

                    if (!data.connected) {
                        statusHeader.classList.add('hidden');
                        statusError.classList.add('visible');
                        errorMessage.textContent = data.error || 'Verbindung zum UniFi Controller nicht m√∂glich';
                        hasLoadedOnce = false;
                        return;
                    }

                    statusHeader.classList.remove('hidden');
                    hasLoadedOnce = true;

                    const system = data.system;
                    const health = data.health || {};

                    document.getElementById('gateway-model').textContent = system.gateway_model || 'Unbekannt';
                    document.getElementById('cpu-value').textContent = system.cpu_utilization ? `${Math.round(system.cpu_utilization)}%` : '--%';
                    document.getElementById('ram-value').textContent = system.mem_utilization ? `${Math.round(system.mem_utilization)}%` : '--%';
                    document.getElementById('uptime-value').textContent = formatUptime(system.uptime);
                    document.getElementById('wan-value').textContent = system.wan_status === 'connected' ? 'Online' : 'Offline';
                    document.getElementById('wan-icon').textContent = system.wan_status === 'connected' ? 'üü¢' : 'üî¥';
                    document.getElementById('clients-value').textContent = system.client_count || '0';

                    document.getElementById('ap-count').textContent = system.ap_count || '0';
                    document.getElementById('switch-count').textContent = system.switch_count || '0';
                    document.getElementById('client-count-detail').textContent = system.client_count || '0';
                    document.getElementById('gateway-model-detail').textContent = system.gateway_model || 'Unbekannt';
                    document.getElementById('gateway-version').textContent = system.gateway_version || '--';

                    const wanIpEl = document.getElementById('wan-ip');
                    const wanIp = system.wan_ip || '--';
                    wanIpEl.dataset.ip = wanIp;
                    wanIpEl.textContent = wanIp === '--' ? '--' : '(zum Anzeigen klicken)';
                    wanIpEl.dataset.revealed = 'false';

                    const wanAvail = health.wan?.availability;
                    document.getElementById('wan-availability').textContent = wanAvail ? `${wanAvail.toFixed(2)}%` : '--';

                    if (health.wan2) {
                        document.getElementById('wan2-row').style.display = 'flex';
                        document.getElementById('wan2-availability-row').style.display = 'flex';
                        const wan2IpEl = document.getElementById('wan2-ip');
                        const wan2Ip = health.wan2.wan_ip || '--';
                        wan2IpEl.dataset.ip = wan2Ip;
                        wan2IpEl.textContent = wan2Ip === '--' ? '--' : '(zum Anzeigen klicken)';
                        wan2IpEl.dataset.revealed = 'false';
                        const wan2Avail = health.wan2.availability;
                        document.getElementById('wan2-availability').textContent = wan2Avail ? `${wan2Avail.toFixed(2)}%` : '--';
                    } else {
                        document.getElementById('wan2-row').style.display = 'none';
                        document.getElementById('wan2-availability-row').style.display = 'none';
                    }

                    const wwwLatency = health.www?.latency;
                    document.getElementById('wan-latency').textContent = wwwLatency ? `${Math.round(wwwLatency)} ms` : '--';
                    document.getElementById('current-download').textContent = formatThroughput(health.www?.rx_bytes);
                    document.getElementById('current-upload').textContent = formatThroughput(health.www?.tx_bytes);

                    setHealthBadge('wan-health', health.wan?.status, health.wan?.status_reason);
                    setHealthBadge('lan-health', health.lan?.status, health.lan?.status_reason);
                    setHealthBadge('wlan-health', health.wlan?.status, health.wlan?.status_reason);

                    if (health.wan2) {
                        document.getElementById('wan2-health-row').style.display = 'flex';
                        setHealthBadge('wan2-health', health.wan2.status, health.wan2.status_reason);
                    } else {
                        document.getElementById('wan2-health-row').style.display = 'none';
                    }

                    if (health.vpn && !(health.vpn.status === 'error' && health.vpn.status_reason === 'not configured')) {
                        document.getElementById('vpn-health-row').style.display = 'flex';
                        setHealthBadge('vpn-health', health.vpn.status, health.vpn.status_reason);
                    } else {
                        document.getElementById('vpn-health-row').style.display = 'none';
                    }

                } catch (error) {
                    console.error('Systemstatus konnte nicht geladen werden:', error);
                    statusLoading.classList.remove('visible');
                    statusError.classList.add('visible');
                    errorMessage.textContent = 'Systemstatus konnte nicht geladen werden';
                }
            }

            loadSystemStatus().then(() => {
                window.systemStatusLoadedFired = true;
                window.dispatchEvent(new CustomEvent('systemStatusLoaded'));
            });

            setInterval(loadSystemStatus, 60000);
        })();

        // UniFi Konfigurationsmodal
        (function() {
            const configModal = document.getElementById('config-modal');
            const configureLink = document.getElementById('configure-link');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const cancelConfigBtn = document.getElementById('cancel-config-btn');
            const configForm = document.getElementById('config-form');
            const testConnectionBtn = document.getElementById('test-connection-btn');
            const configMessage = document.getElementById('config-message');

            function showConfigMessage(message, type = 'info') {
                configMessage.textContent = message;
                configMessage.className = `message ${type}`;
                configMessage.style.display = 'block';
                setTimeout(() => {
                    configMessage.style.display = 'none';
                }, 5000);
            }

            function openModal() {
                configModal.style.display = 'flex';
                loadExistingConfig();
            }

            function closeModal() {
                configModal.style.display = 'none';
                configMessage.style.display = 'none';
            }

            async function loadExistingConfig() {
                try {
                    const response = await fetch('/api/config/unifi');
                    if (response.ok) {
                        const config = await response.json();
                        document.getElementById('controller_url').value = config.controller_url || '';
                        document.getElementById('username').value = config.username || 'admin';
                        document.getElementById('site_id').value = config.site_id || 'default';
                        document.getElementById('verify_ssl').checked = config.verify_ssl || false;
                    }
                } catch (error) {
                    console.log('Keine bestehende Konfiguration gefunden');
                }
            }

            async function saveConfig(e) {
                e.preventDefault();

                const formData = new FormData(configForm);
                const data = {
                    controller_url: formData.get('controller_url'),
                    username: formData.get('username') || 'admin',
                    password: formData.get('password') || null,
                    api_key: formData.get('api_key') || null,
                    site_id: formData.get('site_id') || 'default',
                    verify_ssl: formData.get('verify_ssl') === 'on'
                };

                if (!data.password && !data.api_key) {
                    showConfigMessage('Bitte entweder ein Passwort oder einen API Key angeben', 'error');
                    return;
                }

                const saveBtn = configForm.querySelector('button[type="submit"]');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Verbindung wird getestet...';

                try {
                    showConfigMessage('Verbindung wird vor dem Speichern getestet...', 'info');

                    const testResponse = await fetch('/api/config/unifi/test', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(data)
                    });

                    const testResult = await testResponse.json();

                    if (!testResult.connected) {
                        showConfigMessage(`Verbindung fehlgeschlagen: ${testResult.error || 'Verbindung nicht m√∂glich'}. Konfiguration wurde NICHT gespeichert.`, 'error');
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Konfiguration speichern';
                        return;
                    }

                    saveBtn.textContent = 'Wird gespeichert...';

                    const response = await fetch('/api/config/unifi', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        let message = `Verbindung best√§tigt (${testResult.client_count || 0} Clients gefunden). Konfiguration gespeichert!`;
                        showConfigMessage(message, 'success');
                        setTimeout(() => {
                            closeModal();
                            window.location.reload();
                        }, 1500);
                    } else {
                        showConfigMessage(result.detail || 'Konfiguration konnte nicht gespeichert werden', 'error');
                    }
                } catch (error) {
                    showConfigMessage('Fehler: ' + error.message, 'error');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Konfiguration speichern';
                }
            }

            async function testConnection() {
                const formData = new FormData(configForm);
                const data = {
                    controller_url: formData.get('controller_url'),
                    username: formData.get('username') || 'admin',
                    password: formData.get('password') || null,
                    api_key: formData.get('api_key') || null,
                    site_id: formData.get('site_id') || 'default',
                    verify_ssl: formData.get('verify_ssl') === 'on'
                };

                if (!data.password && !data.api_key) {
                    showConfigMessage('Bitte entweder ein Passwort oder einen API Key angeben', 'error');
                    return;
                }

                if (!data.controller_url) {
                    showConfigMessage('Bitte eine Controller-URL eingeben', 'error');
                    return;
                }

                testConnectionBtn.disabled = true;
                testConnectionBtn.textContent = 'Wird getestet...';
                showConfigMessage('Verbindung zum UniFi Controller wird getestet...', 'info');

                try {
                    const response = await fetch('/api/config/unifi/test', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();

                    if (result.connected) {
                        let message = `‚úì Verbindung erfolgreich! ${result.client_count || 0} Clients gefunden`;
                        if (result.site_name) {
                            message += ` in Standort ‚Äû${result.site_name}"`;
                        }
                        showConfigMessage(message, 'success');
                    } else {
                        showConfigMessage(`‚úó Verbindung fehlgeschlagen: ${result.error || 'Unbekannter Fehler'}`, 'error');
                    }
                } catch (error) {
                    showConfigMessage('Fehler beim Testen der Verbindung: ' + error.message, 'error');
                } finally {
                    testConnectionBtn.disabled = false;
                    testConnectionBtn.textContent = 'Verbindung testen';
                }
            }

            const settingsBtn = document.getElementById('settings-btn');
            settingsBtn.addEventListener('click', openModal);
            configureLink.addEventListener('click', (e) => {
                e.preventDefault();
                openModal();
            });
            closeModalBtn.addEventListener('click', closeModal);
            cancelConfigBtn.addEventListener('click', closeModal);
            configForm.addEventListener('submit', saveConfig);
            testConnectionBtn.addEventListener('click', testConnection);
            configModal.addEventListener('click', (e) => {
                if (e.target === configModal) {
                    closeModal();
                }
            });
        })();

        // Gateway-Pr√ºfung f√ºr Threat Watch
        (function() {
            const threatWatchCard = document.getElementById('threat-watch-card');
            const threatWatchBtn = document.getElementById('threat-watch-btn');
            const threatWatchStatus = document.getElementById('threat-watch-status');

            async function checkGatewayAvailability(forceRefresh = false) {
                threatWatchStatus.classList.remove('status-success');
                threatWatchStatus.style.color = '';

                try {
                    const url = forceRefresh ? '/api/config/gateway-check?refresh=1' : '/api/config/gateway-check';
                    const response = await fetch(url);
                    const data = await response.json();

                    if (!data.configured) {
                        threatWatchCard.classList.add('tool-unavailable');
                        threatWatchBtn.classList.add('disabled');
                        threatWatchBtn.style.pointerEvents = 'none';
                        threatWatchStatus.style.display = 'block';
                        threatWatchStatus.innerHTML = '‚ö†Ô∏è <strong>UniFi nicht konfiguriert.</strong> Einstellungen ‚öôÔ∏è oben verwenden.';
                        return;
                    }

                    if (!data.has_gateway) {
                        threatWatchCard.classList.add('tool-unavailable');
                        threatWatchBtn.classList.add('disabled');
                        threatWatchBtn.style.pointerEvents = 'none';
                        threatWatchStatus.style.display = 'block';
                        threatWatchStatus.innerHTML = '‚ö†Ô∏è <strong>Kein UniFi Gateway gefunden.</strong> IDS/IPS erfordert ein Gateway (UDM, UCG, UXG, USG).';
                    } else if (!data.supports_ids_ips) {
                        const gatewayName = data.gateway_name || 'Ihr Gateway';
                        const isLegacyController = gatewayName.includes('Legacy Controller');
                        threatWatchCard.classList.add('tool-unavailable');
                        threatWatchBtn.classList.add('disabled');
                        threatWatchBtn.style.pointerEvents = 'none';
                        threatWatchStatus.style.display = 'block';
                        if (isLegacyController) {
                            threatWatchStatus.innerHTML = `‚ö†Ô∏è <strong>IDS/IPS API nicht verf√ºgbar.</strong> Legacy Controller unterst√ºtzen diese Endpunkte nicht.`;
                        } else {
                            threatWatchStatus.innerHTML = `‚ö†Ô∏è <strong>${gatewayName}</strong> unterst√ºtzt kein IDS/IPS.`;
                        }
                    } else {
                        threatWatchCard.classList.remove('tool-unavailable');
                        threatWatchBtn.classList.remove('disabled');
                        threatWatchBtn.style.pointerEvents = 'auto';

                        if (data.ips_enabled === false) {
                            threatWatchStatus.style.display = 'block';
                            threatWatchStatus.innerHTML = `‚ÑπÔ∏è <strong>IDS/IPS ist deaktiviert</strong> auf ${data.gateway_name}.<span class="check-again" onclick="window.recheckGateway()">Ich habe es aktiviert ‚Äì erneut pr√ºfen</span>`;
                        } else {
                            threatWatchStatus.style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error('Gateway-Verf√ºgbarkeit konnte nicht gepr√ºft werden:', error);
                }
            }

            window.recheckGateway = async function() {
                threatWatchStatus.innerHTML = '‚è≥ Wird gepr√ºft...';
                try {
                    await fetch('/api/config/gateway-check?invalidate=1');
                } catch (e) {}
                setTimeout(() => checkGatewayAvailability(true), 500);
            };

            window.addEventListener('systemStatusLoaded', () => {
                checkGatewayAvailability();
            }, { once: true });

            setTimeout(() => {
                if (!window.systemStatusLoadedFired) {
                    checkGatewayAvailability();
                }
            }, 5000);
        })();

        // Problem-melden Link
        (function() {
            const reportLink = document.getElementById('report-issue-link');
            const GITHUB_REPO = 'https://github.com/axelweichert/unifi-toolkit';

            reportLink.addEventListener('click', async function(e) {
                e.preventDefault();

                let body = `## Beschreibung
<!-- Bitte das aufgetretene Problem beschreiben -->


## Schritte zur Reproduktion
<!-- Welche Schritte f√ºhren zum Problem? -->
1.
2.
3.

## Erwartetes Verhalten
<!-- Was h√§tte passieren sollen? -->


## Tats√§chliches Verhalten
<!-- Was ist tats√§chlich passiert? -->


## Umgebung
`;

                try {
                    const response = await fetch('/api/debug-info');
                    const info = await response.json();

                    body += `- **App-Version:** ${info.app_version}\n`;
                    body += `- **Tool-Versionen:**\n`;
                    body += `  - Wi-Fi Stalker: ${info.tool_versions.wifi_stalker}\n`;
                    body += `  - Threat Watch: ${info.tool_versions.threat_watch}\n`;
                    body += `  - Network Pulse: ${info.tool_versions.network_pulse}\n`;
                    body += `- **Deployment:**\n`;
                    body += `  - Typ: ${info.deployment.type}\n`;
                    body += `  - Docker: ${info.deployment.docker ? 'Ja' : 'Nein'}\n`;
                    body += `  - Python: ${info.deployment.python_version}\n`;

                    if (info.gateway.model) {
                        body += `- **Gateway:**\n`;
                        body += `  - Modell: ${info.gateway.model}`;
                        if (info.gateway.name) {
                            body += ` (${info.gateway.name})`;
                        }
                        body += `\n`;
                        body += `  - UniFi OS: ${info.gateway.is_unifi_os ? 'Ja' : 'Nein'}\n`;
                        body += `  - IDS/IPS Unterst√ºtzung: ${info.gateway.supports_ids_ips ? 'Ja' : 'Nein'}\n`;
                        if (info.gateway.ips_mode) {
                            body += `  - IPS-Modus: ${info.gateway.ips_mode}\n`;
                        }
                    } else {
                        body += `- **Gateway:** Nicht konfiguriert oder keine Verbindung\n`;
                    }

                } catch (error) {
                    body += `- **App-Version:** {{ app_version }}\n`;
                    body += `- _(Zus√§tzliche Debug-Informationen konnten nicht abgerufen werden)_\n`;
                }

                body += `- **Browser:** ${navigator.userAgent}\n`;

                const issueUrl = `${GITHUB_REPO}/issues/new?` + new URLSearchParams({
                    title: '',
                    body: body,
                    labels: 'bug'
                }).toString();

                window.open(issueUrl, '_blank');
            });
        })();
    </script>
</body>
</html>
