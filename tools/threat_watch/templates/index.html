<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threat Watch - IDS/IPS √úberwachungs-Dashboard</title>
    <link rel="icon" type="image/jpeg" href="/static/images/favicon16x16.jpg">
    <link rel="stylesheet" href="/threats/static/css/styles.css">
    <script>
        // Apply saved theme immediately to prevent flash
        (function() {
            const savedTheme = localStorage.getItem('unifi-toolkit-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
    <div x-data="dashboard()" x-init="init()" class="container">
        <!-- Header -->
        <header>
            <div class="header-top">
                <a href="/" class="back-to-dashboard">
                    ‚Üê Zur√ºck zum Dashboard
                </a>
            </div>
            <h1>üõ°Ô∏è Threat Watch</h1>
            <p class="subtitle">IDS/IPS-√úberwachung und Bedrohungsanalyse f√ºr UniFi-Netzwerke</p>
            <p class="refresh-info">Ereignisse werden automatisch alle <span x-text="refreshInterval || 60"></span> Sekunden aktualisiert</p>
            <div class="status-bar">
                <span class="status-item">
                    <span class="label">Letztes Update:</span>
                    <span x-text="lastRefresh || 'Nie'"></span>
                </span>
                <span class="status-item">
                    <span class="label">Ereignisse gesamt:</span>
                    <span x-text="totalEvents"></span>
                </span>
                <span class="status-item">
                    <span class="label">Letzte 24h:</span>
                    <span x-text="events24h"></span>
                </span>
                <span class="status-item">
                    <span class="label">Ignoriert:</span>
                    <span x-text="stats.ignoredCount"></span>
                </span>
            </div>
        </header>

        <!-- Gateway/IDS Warnung -->
        {% if not supports_ids_ips %}
        <div class="gateway-warning">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <div class="warning-content">
                {% if gateway_info and gateway_info.has_gateway and not gateway_info.supports_ids_ips %}
                <h3>IDS/IPS nicht verf√ºgbar</h3>
                <p><strong>{{ gateway_error }}</strong></p>
                <p>Threat Watch √ºberwacht IDS/IPS-Ereignisse (Intrusion Detection/Prevention System). Obwohl dein Standort ein Gateway-Ger√§t besitzt, unterst√ºtzt dieses Modell keine IDS/IPS-Funktionen.</p>
                {% elif gateway_error == "Loading gateway information..." %}
                <h3>Wird geladen...</h3>
                <p>Gateway-Konfiguration wird gepr√ºft. Bitte warten oder Seite neu laden.</p>
                {% else %}
                <h3>UniFi Gateway erforderlich</h3>
                <p><strong>{{ gateway_error }}</strong></p>
                <p>Threat Watch √ºberwacht IDS/IPS-Ereignisse (Intrusion Detection/Prevention System), die nur auf UniFi Gateway-Ger√§ten wie UDM, UCG, UXG oder USG verf√ºgbar sind.</p>
                <p>Dein UniFi-Standort scheint Access Points und/oder Switches zu haben, aber kein Gateway. Ohne Gateway gibt es keine IDS/IPS-Ereignisse zur √úberwachung.</p>
                {% endif %}
                <div class="warning-actions">
                    <a href="/" class="btn btn-primary">‚Üê Zur√ºck zum Dashboard</a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- IDS/IPS deaktiviert Warnung -->
        {% if supports_ids_ips and gateway_error == "ids_disabled" %}
        <div class="gateway-warning" style="background-color: var(--warning-bg, #fff3cd); border-color: var(--warning-border, #ffc107);">
            <div class="warning-icon">‚ÑπÔ∏è</div>
            <div class="warning-content">
                <h3>IDS/IPS ist deaktiviert</h3>
                <p>Dein Gateway ({{ gateway_info.gateway_name }}) unterst√ºtzt IDS/IPS, ist aber aktuell in den UniFi-Einstellungen <strong>deaktiviert</strong>.</p>
                <p>So aktivierst du die Bedrohungserkennung:</p>
                <ol style="margin: 0.5rem 0; padding-left: 1.5rem;">
                    <li>√ñffne dein UniFi Network Dashboard</li>
                    <li>Gehe zu <strong>Einstellungen ‚Üí Sicherheit ‚Üí Internet-Bedrohungsmanagement</strong></li>
                    <li>Aktiviere <strong>Intrusion Detection</strong> (IDS) oder <strong>Intrusion Prevention</strong> (IPS)</li>
                </ol>
                <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">
                    <strong>IDS</strong> = Nur erkennen und melden | <strong>IPS</strong> = Erkennen und Bedrohungen blockieren
                </p>
            </div>
        </div>
        {% endif %}

        <!-- IDS/IPS Status-Badge (wenn aktiviert) -->
        {% if supports_ids_ips and ips_settings and ips_settings.ips_enabled %}
        <div class="ips-status-badge">
            <span style="font-size: 1.2rem;">üõ°Ô∏è</span>
            <span>
                <strong>{{ ips_settings.ips_mode|upper }}</strong> Modus aktiv
                {% if ips_settings.ips_mode == "ids" %}
                    (Bedrohungen werden erkannt)
                {% elif ips_settings.ips_mode == "ips" or ips_settings.ips_mode == "ipsInline" %}
                    (Bedrohungen werden erkannt &amp; blockiert)
                {% endif %}
            </span>
        </div>
        {% endif %}

        <!-- Statistik-Karten -->
        <div class="stats-grid">
            <div class="stat-card severity-high">
                <div class="stat-value" x-text="stats.highCount || 0"></div>
                <div class="stat-label">Hohe Schwere</div>
            </div>
            <div class="stat-card severity-medium">
                <div class="stat-value" x-text="stats.mediumCount || 0"></div>
                <div class="stat-label">Mittlere Schwere</div>
            </div>
            <div class="stat-card severity-low">
                <div class="stat-value" x-text="stats.lowCount || 0"></div>
                <div class="stat-label">Niedrige Schwere</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-value" x-text="stats.blockedCount || 0"></div>
                <div class="stat-label">Blockiert</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab" :class="{ active: activeTab === 'events' }" @click="activeTab = 'events'">
                Ereignisse
            </button>
            <button class="tab" :class="{ active: activeTab === 'attackers' }" @click="activeTab = 'attackers'">
                Top-Angreifer
            </button>
            <button class="tab" :class="{ active: activeTab === 'categories' }" @click="activeTab = 'categories'">
                Kategorien
            </button>
            <button class="tab" :class="{ active: activeTab === 'ignore' }" @click="activeTab = 'ignore'">
                Ignorierliste
            </button>
        </div>

        <!-- Hauptinhalt -->
        <main>
            <!-- Ereignisse-Tab -->
            <div x-show="activeTab === 'events'">
                <!-- Aktionsleiste -->
                <div class="action-bar">
                    <button @click="showWebhooks = true" class="btn btn-secondary">
                        üîî Webhooks
                    </button>
                </div>

                <!-- Filterleiste -->
                <div class="filter-bar">
                    <select x-model="filters.severity" @change="loadEvents()">
                        <option value="">Alle Schweregrade</option>
                        <option value="1">Hoch</option>
                        <option value="2">Mittel</option>
                        <option value="3">Niedrig</option>
                    </select>
                    <select x-model="filters.action" @change="loadEvents()">
                        <option value="">Alle Aktionen</option>
                        <option value="block">Blockiert</option>
                        <option value="alert">Nur Alarm</option>
                    </select>
                    <select x-model="filters.category" @change="loadEvents()">
                        <option value="">Alle Kategorien</option>
                        <template x-for="cat in categories" :key="cat">
                            <option :value="cat" x-text="cat"></option>
                        </template>
                    </select>
                    <div class="search-box">
                        <input type="text"
                               x-model="filters.search"
                               @keyup.enter="loadEvents()"
                               placeholder="üîç Signaturen, IPs suchen..."
                               class="search-input">
                    </div>
                    <label class="filter-checkbox">
                        <input type="checkbox" x-model="filters.includeIgnored" @change="loadEvents(); loadStats()">
                        Ignorierte anzeigen
                    </label>
                </div>

                <!-- Ereignistabelle -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th @click="sortBy('timestamp')" class="sortable">
                                    Zeitpunkt
                                    <span x-show="sortColumn === 'timestamp'" x-text="sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'"></span>
                                </th>
                                <th @click="sortBy('severity')" class="sortable">
                                    Schwere
                                    <span x-show="sortColumn === 'severity'" x-text="sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'"></span>
                                </th>
                                <th>Signatur</th>
                                <th>Kategorie</th>
                                <th>Quelle</th>
                                <th>Ziel</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-if="events.length === 0 && !isLoading">
                                <tr>
                                    <td colspan="7" class="empty-state">
                                        Keine Bedrohungsereignisse gefunden. Dein Netzwerk ist m√∂glicherweise sicher, oder IDS/IPS ist nicht aktiviert.
                                    </td>
                                </tr>
                            </template>
                            <template x-if="isLoading">
                                <tr>
                                    <td colspan="7">
                                        <div class="loading">
                                            <div class="spinner"></div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                            <template x-for="event in events" :key="event.id">
                                <tr @click="viewEventDetails(event.id)">
                                    <td x-text="formatDateTime(event.timestamp)"></td>
                                    <td>
                                        <span class="severity-badge"
                                              :class="getSeverityClass(event.severity)"
                                              x-text="getSeverityLabel(event.severity)">
                                        </span>
                                    </td>
                                    <td>
                                        <div x-text="truncate(event.signature || event.message || 'Unbekannt', 40)"></div>
                                    </td>
                                    <td x-text="event.category || '-'"></td>
                                    <td>
                                        <div>
                                            <code x-text="event.src_ip || '-'"></code>
                                            <span x-show="event.src_port" x-text="':' + event.src_port"></span>
                                        </div>
                                        <div x-show="event.src_country" class="country-badge">
                                            <span x-text="event.src_country"></span>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <code x-text="event.dest_ip || '-'"></code>
                                            <span x-show="event.dest_port" x-text="':' + event.dest_port"></span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="action-badge"
                                              :class="event.action === 'block' ? 'action-block' : 'action-alert'"
                                              x-text="event.action === 'block' ? 'Blockiert' : 'Alarm'">
                                        </span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Seitennavigation -->
                <div class="pagination" x-show="totalPages > 1">
                    <button @click="prevPage()" :disabled="currentPage === 1" class="btn btn-secondary btn-small">
                        ‚Üê Zur√ºck
                    </button>
                    <span class="pagination-info">
                        Seite <span x-text="currentPage"></span> von <span x-text="totalPages"></span>
                    </span>
                    <button @click="nextPage()" :disabled="!hasMore" class="btn btn-secondary btn-small">
                        Weiter ‚Üí
                    </button>
                </div>
            </div>

            <!-- Top-Angreifer-Tab -->
            <div x-show="activeTab === 'attackers'">
                <h2 style="margin-bottom: 1rem;">Top angreifende IPs</h2>
                <div class="attackers-list">
                    <template x-if="stats.topAttackers && stats.topAttackers.length === 0">
                        <div class="empty-state">Noch keine Angriffsdaten verf√ºgbar.</div>
                    </template>
                    <template x-for="attacker in stats.topAttackers" :key="attacker.ip">
                        <div class="attacker-item" @click="filterByIp(attacker.ip)">
                            <div class="attacker-info">
                                <div class="attacker-ip" x-text="attacker.ip"></div>
                                <div class="attacker-meta">
                                    <span x-show="attacker.country" x-text="attacker.country + ' ‚Ä¢ '"></span>
                                    <span x-show="attacker.org" x-text="attacker.org"></span>
                                    <span x-show="!attacker.country && !attacker.org">Unbekannte Herkunft</span>
                                </div>
                            </div>
                            <div class="attacker-count" x-text="attacker.count + ' Ereignisse'"></div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Kategorien-Tab -->
            <div x-show="activeTab === 'categories'">
                <h2 style="margin-bottom: 1rem;">Ereignisse nach Kategorie</h2>
                <div class="categories-grid">
                    <template x-if="stats.byCategory && stats.byCategory.length === 0">
                        <div class="empty-state">Noch keine Kategoriedaten verf√ºgbar.</div>
                    </template>
                    <template x-for="cat in stats.byCategory" :key="cat.category">
                        <div class="category-item" @click="filterByCategory(cat.category)">
                            <div class="category-name" x-text="cat.category"></div>
                            <div class="category-count" x-text="cat.count"></div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Ignorierliste-Tab -->
            <div x-show="activeTab === 'ignore'">
                <div class="ignore-list-header">
                    <div>
                        <h2 style="margin-bottom: 0.5rem;">Ignorierliste</h2>
                        <p class="subtitle">IP-Adressen f√ºr bestimmte Schweregrade ignorieren. N√ºtzlich f√ºr bekannte Ger√§te wie Home Assistant oder andere interne Dienste.</p>
                    </div>
                    <button @click="resetIgnoreRuleForm(); showAddIgnoreRule = true" class="btn btn-primary">
                        + Regel hinzuf√ºgen
                    </button>
                </div>

                <div x-show="ignoreRules.length === 0" class="empty-state">
                    Keine Ignorierregeln konfiguriert. Ereignisse von allen Quellen werden angezeigt.
                </div>

                <div x-show="ignoreRules.length > 0" class="ignore-rules-list">
                    <template x-for="rule in ignoreRules" :key="rule.id">
                        <div class="ignore-rule-item" :class="{ 'rule-disabled': !rule.enabled }">
                            <div class="ignore-rule-content">
                                <div class="ignore-rule-info">
                                    <div class="ignore-rule-header">
                                        <code class="ignore-rule-ip" x-text="rule.ip_address"></code>
                                        <span x-show="rule.description" class="ignore-rule-desc" x-text="' ‚Äî ' + rule.description"></span>
                                        <span x-show="!rule.enabled" class="badge badge-disabled">Deaktiviert</span>
                                    </div>
                                    <div class="ignore-severities">
                                        <span>Ignoriert:</span>
                                        <span x-show="rule.ignore_high" class="severity-badge severity-high">Hoch</span>
                                        <span x-show="rule.ignore_medium" class="severity-badge severity-medium">Mittel</span>
                                        <span x-show="rule.ignore_low" class="severity-badge severity-low">Niedrig</span>
                                    </div>
                                    <div class="ignore-match-info">
                                        Treffer:
                                        <span x-show="rule.match_source">Quell-IP</span>
                                        <span x-show="rule.match_source && rule.match_destination"> / </span>
                                        <span x-show="rule.match_destination">Ziel-IP</span>
                                    </div>
                                    <div class="ignore-rule-stats">
                                        <span x-text="rule.events_ignored + ' Ereignisse ignoriert'"></span>
                                        <span x-show="rule.last_matched">
                                            ‚Ä¢ Letzter Treffer: <span x-text="formatDateTime(rule.last_matched)"></span>
                                        </span>
                                    </div>
                                </div>
                                <div class="ignore-rule-actions">
                                    <button @click="editIgnoreRule(rule)" class="btn btn-sm btn-secondary">Bearbeiten</button>
                                    <button @click="deleteIgnoreRule(rule.id)" class="btn btn-sm btn-danger">L√∂schen</button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </main>

        <!-- Ereignisdetails-Modal -->
        <div x-show="showEventDetails"
             @click.self="showEventDetails = false"
             class="modal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2>Bedrohungsereignis-Details</h2>
                    <button @click="showEventDetails = false" class="close-btn">√ó</button>
                </div>
                <div class="modal-body" x-show="eventDetails">
                    <div class="event-details-grid">
                        <!-- Alarm-Informationen -->
                        <div class="detail-section">
                            <h3>Alarm-Informationen</h3>
                            <div class="detail-item">
                                <span class="detail-label">Signatur:</span>
                                <span class="detail-value" x-text="eventDetails?.signature || '-'"></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Meldung:</span>
                                <span class="detail-value" x-text="eventDetails?.message || '-'"></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Kategorie:</span>
                                <span class="detail-value" x-text="eventDetails?.category || '-'"></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Schwere:</span>
                                <span class="detail-value">
                                    <span class="severity-badge"
                                          :class="getSeverityClass(eventDetails?.severity)"
                                          x-text="getSeverityLabel(eventDetails?.severity)">
                                    </span>
                                </span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Aktion:</span>
                                <span class="detail-value">
                                    <span class="action-badge"
                                          :class="eventDetails?.action === 'block' ? 'action-block' : 'action-alert'"
                                          x-text="eventDetails?.action === 'block' ? 'Blockiert' : 'Alarm'">
                                    </span>
                                </span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Zeitpunkt:</span>
                                <span class="detail-value" x-text="formatDateTime(eventDetails?.timestamp)"></span>
                            </div>
                        </div>

                        <!-- Quellinformationen -->
                        <div class="detail-section">
                            <h3>Quelle</h3>
                            <div class="detail-item">
                                <span class="detail-label">IP-Adresse:</span>
                                <span class="detail-value"><code x-text="eventDetails?.src_ip || '-'"></code></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Port:</span>
                                <span class="detail-value" x-text="eventDetails?.src_port || '-'"></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">MAC:</span>
                                <span class="detail-value"><code x-text="eventDetails?.src_mac || '-'"></code></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Land:</span>
                                <span class="detail-value" x-text="eventDetails?.src_country || '-'"></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Stadt:</span>
                                <span class="detail-value" x-text="eventDetails?.src_city || '-'"></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Organisation:</span>
                                <span class="detail-value" x-text="eventDetails?.src_org || '-'"></span>
                            </div>
                        </div>

                        <!-- Zielinformationen -->
                        <div class="detail-section">
                            <h3>Ziel</h3>
                            <div class="detail-item">
                                <span class="detail-label">IP-Adresse:</span>
                                <span class="detail-value"><code x-text="eventDetails?.dest_ip || '-'"></code></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Port:</span>
                                <span class="detail-value" x-text="eventDetails?.dest_port || '-'"></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">MAC:</span>
                                <span class="detail-value"><code x-text="eventDetails?.dest_mac || '-'"></code></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Land:</span>
                                <span class="detail-value" x-text="eventDetails?.dest_country || '-'"></span>
                            </div>
                        </div>

                        <!-- Netzwerkinformationen -->
                        <div class="detail-section">
                            <h3>Netzwerk</h3>
                            <div class="detail-item">
                                <span class="detail-label">Protokoll:</span>
                                <span class="detail-value" x-text="eventDetails?.protocol || '-'"></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">App-Protokoll:</span>
                                <span class="detail-value" x-text="eventDetails?.app_protocol || '-'"></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Schnittstelle:</span>
                                <span class="detail-value" x-text="eventDetails?.interface || '-'"></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Signatur-ID:</span>
                                <span class="detail-value" x-text="eventDetails?.signature_id || '-'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Externe Lookup-Links -->
                    <div x-show="eventDetails?.src_ip" class="external-links">
                        <template x-if="isPrivateIP(eventDetails?.src_ip)">
                            <div class="private-ip-notice">
                                ‚ÑπÔ∏è Externe Abfragen sind f√ºr private (RFC1918) IP-Adressen nicht verf√ºgbar.
                            </div>
                        </template>
                        <a :href="'https://www.abuseipdb.com/check/' + eventDetails?.src_ip"
                           target="_blank" class="external-link"
                           :class="{ 'link-disabled': isPrivateIP(eventDetails?.src_ip) }"
                           @click.prevent="isPrivateIP(eventDetails?.src_ip) && $event.preventDefault()"
                           :aria-disabled="isPrivateIP(eventDetails?.src_ip)">
                            üîç AbuseIPDB
                        </a>
                        <a :href="'https://www.virustotal.com/gui/ip-address/' + eventDetails?.src_ip"
                           target="_blank" class="external-link"
                           :class="{ 'link-disabled': isPrivateIP(eventDetails?.src_ip) }"
                           @click.prevent="isPrivateIP(eventDetails?.src_ip) && $event.preventDefault()"
                           :aria-disabled="isPrivateIP(eventDetails?.src_ip)">
                            ü¶† VirusTotal
                        </a>
                        <a :href="'https://www.shodan.io/host/' + eventDetails?.src_ip"
                           target="_blank" class="external-link"
                           :class="{ 'link-disabled': isPrivateIP(eventDetails?.src_ip) }"
                           @click.prevent="isPrivateIP(eventDetails?.src_ip) && $event.preventDefault()"
                           :aria-disabled="isPrivateIP(eventDetails?.src_ip)">
                            üîé Shodan
                        </a>
                    </div>

                    <!-- Zur Ignorierliste hinzuf√ºgen -->
                    <div x-show="eventDetails?.src_ip" class="ignore-action">
                        <button @click="openIgnoreFromEvent()" class="btn btn-secondary">
                            üö´ Zur Ignorierliste hinzuf√ºgen
                        </button>
                        <small>Zuk√ºnftige Ereignisse von dieser Quell-IP ignorieren</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Webhooks-Modal -->
        <div x-show="showWebhooks"
             @click.self="showWebhooks = false"
             class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Webhooks</h2>
                    <button @click="showWebhooks = false" class="close-btn">√ó</button>
                </div>
                <div class="modal-body">
                    <p class="subtitle">
                        Webhooks konfigurieren, um Benachrichtigungen bei Bedrohungsereignissen zu erhalten.
                    </p>

                    <button type="button" @click="showAddWebhook = true" class="btn btn-primary" style="margin-bottom: 1rem;">
                        + Webhook hinzuf√ºgen
                    </button>

                    <div x-show="webhooks.length === 0" class="empty-state">
                        Keine Webhooks konfiguriert.
                    </div>

                    <div x-show="webhooks.length > 0" class="webhooks-list">
                        <template x-for="webhook in webhooks" :key="webhook.id">
                            <div class="webhook-item">
                                <div class="webhook-item-content">
                                    <div class="webhook-item-info">
                                        <strong x-text="webhook.name"></strong>
                                        <span class="badge webhook-type-badge" x-text="webhook.webhook_type"></span>
                                        <span x-show="!webhook.enabled" class="badge webhook-disabled-badge">Deaktiviert</span>
                                        <div class="webhook-events">
                                            Ereignisse:
                                            <span x-show="webhook.event_alert">Alarme</span>
                                            <span x-show="webhook.event_block">Blockierungen</span>
                                        </div>
                                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                            Mindestschwere: <span x-text="getSeverityLabel(webhook.min_severity)"></span>
                                        </div>
                                    </div>
                                    <div class="webhook-item-actions">
                                        <button type="button" @click="testWebhook(webhook.id)" class="btn btn-sm btn-secondary">Testen</button>
                                        <button type="button" @click="editWebhook(webhook)" class="btn btn-sm btn-secondary">Bearbeiten</button>
                                        <button type="button" @click="deleteWebhook(webhook.id)" class="btn btn-sm btn-danger">L√∂schen</button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Webhook hinzuf√ºgen/bearbeiten Modal -->
        <div x-show="showAddWebhook || showEditWebhook"
             @click.self="showAddWebhook = false; showEditWebhook = false"
             class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 x-text="showEditWebhook ? 'Webhook bearbeiten' : 'Webhook hinzuf√ºgen'"></h2>
                    <button @click="showAddWebhook = false; showEditWebhook = false" class="close-btn">√ó</button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveWebhook()">
                        <div class="form-group">
                            <label for="webhook_name">Name</label>
                            <input type="text"
                                   id="webhook_name"
                                   x-model="webhookForm.name"
                                   required
                                   placeholder="Slack-Alarme">
                        </div>

                        <div class="form-group">
                            <label for="webhook_type">Typ</label>
                            <select id="webhook_type" x-model="webhookForm.webhook_type" required>
                                <option value="slack">Slack</option>
                                <option value="discord">Discord</option>
                                <option value="n8n">n8n / Generisch</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="webhook_url">Webhook-URL</label>
                            <input type="url"
                                   id="webhook_url"
                                   x-model="webhookForm.url"
                                   required
                                   placeholder="https://hooks.slack.com/services/...">
                        </div>

                        <div class="form-group">
                            <label for="min_severity">Minimale Schwere f√ºr Alarm</label>
                            <select id="min_severity" x-model="webhookForm.min_severity">
                                <option value="1">Nur Hoch</option>
                                <option value="2">Mittel und h√∂her</option>
                                <option value="3">Alle (inkl. Niedrig)</option>
                            </select>
                            <small>Nur Ereignisse ab dieser Schwere l√∂sen den Webhook aus</small>
                        </div>

                        <div class="form-group">
                            <label>Ausl√∂seereignisse</label>
                            <div>
                                <label class="checkbox-label">
                                    <input type="checkbox" x-model="webhookForm.event_alert">
                                    IDS-Alarme
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" x-model="webhookForm.event_block">
                                    IPS-Blockierungen
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" x-model="webhookForm.enabled">
                                Aktiviert
                            </label>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Webhook speichern</button>
                            <button type="button" @click="showAddWebhook = false; showEditWebhook = false" class="btn btn-secondary">
                                Abbrechen
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Ignorierregel hinzuf√ºgen/bearbeiten Modal -->
        <div x-show="showAddIgnoreRule || showEditIgnoreRule"
             @click.self="showAddIgnoreRule = false; showEditIgnoreRule = false"
             class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 x-text="showEditIgnoreRule ? 'Ignorierregel bearbeiten' : 'Ignorierregel hinzuf√ºgen'"></h2>
                    <button @click="showAddIgnoreRule = false; showEditIgnoreRule = false" class="close-btn">√ó</button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveIgnoreRule()">
                        <div class="form-group">
                            <label for="ignore_ip">IP-Adresse</label>
                            <input type="text"
                                   id="ignore_ip"
                                   x-model="ignoreRuleForm.ip_address"
                                   required
                                   placeholder="192.168.1.100"
                                   pattern="^(\d{1,3}\.){3}\d{1,3}$"
                                   title="G√ºltige IPv4-Adresse eingeben">
                        </div>

                        <div class="form-group">
                            <label for="ignore_description">Beschreibung (optional)</label>
                            <input type="text"
                                   id="ignore_description"
                                   x-model="ignoreRuleForm.description"
                                   placeholder="Home Assistant, Pi-hole, etc.">
                        </div>

                        <div class="form-group">
                            <label>Ereignisse ignorieren bei Schwere:</label>
                            <div class="severity-checkboxes">
                                <label class="checkbox-label">
                                    <input type="checkbox" x-model="ignoreRuleForm.ignore_high">
                                    <span class="severity-badge severity-high">Hoch</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" x-model="ignoreRuleForm.ignore_medium">
                                    <span class="severity-badge severity-medium">Mittel</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" x-model="ignoreRuleForm.ignore_low">
                                    <span class="severity-badge severity-low">Niedrig</span>
                                </label>
                            </div>
                            <small>Nur Ereignisse der markierten Schweregrade werden von dieser IP ignoriert</small>
                        </div>

                        <div class="form-group">
                            <label>IP abgleichen wenn sie die ist:</label>
                            <div>
                                <label class="checkbox-label">
                                    <input type="checkbox" x-model="ignoreRuleForm.match_source">
                                    Quell-IP (Datenverkehr VON diesem Ger√§t)
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" x-model="ignoreRuleForm.match_destination">
                                    Ziel-IP (Datenverkehr AN dieses Ger√§t)
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" x-model="ignoreRuleForm.enabled">
                                Aktiviert
                            </label>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Regel speichern</button>
                            <button type="button" @click="showAddIgnoreRule = false; showEditIgnoreRule = false" class="btn btn-secondary">
                                Abbrechen
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Toast-Benachrichtigungen -->
        <div class="toast-container">
            <div x-show="toast.show"
                 x-transition
                 :class="'toast toast-' + toast.type"
                 x-text="toast.message">
            </div>
        </div>

        <!-- Footer -->
        <footer class="app-footer">
            <p><a href="https://github.com/axelweichert/unifi-toolkit" target="_blank">UI Toolkit - Threat Watch</a> v{{ version }} | by <a href="https://www.vonbusch.digital" target="_blank">vonBusch GmbH</a> | <a href="#" id="report-issue-link">Problem melden</a></p>
            <p class="footer-disclaimer">Nicht verbunden mit Ubiquiti Inc. UniFi ist eine Marke von Ubiquiti Inc.</p>
        </footer>
    </div>

    <script src="/threats/static/js/app.js"></script>
    <script>
        // Report Issue Link Builder
        (function() {
            const reportLink = document.getElementById('report-issue-link');
            const GITHUB_REPO = 'https://github.com/axelweichert/unifi-toolkit';

            reportLink.addEventListener('click', async function(e) {
                e.preventDefault();

                let body = `## Beschreibung
<!-- Bitte beschreibe das Problem -->


## Schritte zur Reproduktion
1.
2.
3.

## Erwartetes Verhalten


## Tats√§chliches Verhalten


## Umgebung
`;

                try {
                    const response = await fetch('/api/debug-info');
                    const info = await response.json();

                    body += `- **App-Version:** ${info.app_version}\n`;
                    body += `- **Tool:** Threat Watch ${info.tool_versions.threat_watch}\n`;
                    body += `- **Deployment:** ${info.deployment.type}, Docker: ${info.deployment.docker ? 'Ja' : 'Nein'}, Python: ${info.deployment.python_version}\n`;
                    if (info.gateway.model) {
                        let gatewayStr = info.gateway.model;
                        if (info.gateway.name) gatewayStr += ` (${info.gateway.name})`;
                        body += `- **Gateway:** ${gatewayStr}, UniFi OS: ${info.gateway.is_unifi_os ? 'Ja' : 'Nein'}\n`;
                        body += `- **IDS/IPS-Unterst√ºtzung:** ${info.gateway.supports_ids_ips ? 'Ja' : 'Nein'}\n`;
                        if (info.gateway.ips_mode) {
                            body += `- **IPS-Modus:** ${info.gateway.ips_mode}\n`;
                        }
                    }
                } catch (error) {
                    body += `- **Tool:** Threat Watch {{ version }}\n`;
                }
                body += `- **Browser:** ${navigator.userAgent}\n`;

                const issueUrl = `${GITHUB_REPO}/issues/new?` + new URLSearchParams({
                    title: '[Threat Watch] ',
                    body: body,
                    labels: 'bug,threat-watch'
                }).toString();

                window.open(issueUrl, '_blank');
            });
        })();
    </script>
</body>
</html>
